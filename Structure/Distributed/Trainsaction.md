分布式事务处理
==

## 1. 引言

### 1.1 事务需要满足ACID特性
- 原子性（Atomicity）
- - 可以理解为一个事务内的所有操作要么都执行，要么都不执行
- 一致性（Consistency）
- - 可以理解为数据是满足完整性约束的，也就是不会存在中间状态的数据
- 隔离性（Isolation）
- - 指的是多个事务并发执行的时候不会互相干扰，即一个事务内部的数据对于其他事务来说是隔离的
- 持久性（Durability）
- - 指的是一个事务完成了之后数据就被永远保存下来，之后的其他操作或故障都不会对事务的结果产生影响

### 1.2 分布式事务
分布式事务就是指事务的参与者、支持事务的服务器、资源服务器以及事务管理器分别位于不同的分布式系统的不同节点之上。
简单的说，就是一次大的操作由不同的小操作组成，这些小的操作分布在不同的服务器上，且属于不同的应用，分布式事务需要保证这些小操作要么全部成功，要么全部失败。
本质上来说，分布式事务就是为了保证不同数据库的数据一致性。

### 1.3 分布式系统的 CAP理论
CAP定理，又被叫作布鲁尔定理

- C (一致性):
- - 对某个指定的客户端来说，读操作能返回最新的写操作。对于数据分布在不同节点上的数据上来说，如果在某个节点更新了数据，那么在其他节点如果都能读取到这个最新的数据，那么就称为强一致，如果有某个节点没有读取到，那就是分布式不一致。
- A (可用性)：
- - 非故障的节点在合理的时间内返回合理的响应(不是错误和超时的响应)。可用性的两个关键一个是合理的时间，一个是合理的响应。合理的时间指的是请求不能无限被阻塞，应该在合理的时间给出返回。合理的响应指的是系统应该明确返回结果并且结果是正确的，这里的正确指的是比如应该返回50，而不是返回40。
- P (分区容错性):
- - 当出现网络分区后，系统能够继续工作。打个比方，这里个集群有多台机器，有台机器网络出现了问题，但是这个集群仍然可以正常工作。

CAP三者不能共有，在分布式系统中，网络无法100%可靠，分区其实是一个必然现象，如果我们选择了CA而放弃了P，那么当发生分区现象时，为了保证一致性，这个时候必须拒绝请求，但是A又不允许，所以分布式系统理论上不可能选择CA架构，只能选择CP或者AP架构。

对于CP来说，放弃可用性，追求一致性和分区容错性，我们的zookeeper其实就是追求的强一致。

对于AP来说，放弃一致性(这里说的一致性是强一致性)，追求分区容错性和可用性，这是很多分布式系统设计时的选择，后面的BASE也是根据AP来扩展。

没有绝对的CA存在，但是我们仍然要尽可能的维护CA。


### 1.4 BASE理论
BASE 是 Basically Available(基本可用)、Soft state(软状态)和 Eventually consistent (最终一致性)三个短语的缩写。是对CAP中AP的一个扩展

- 基本可用
- - 分布式系统在出现故障时，允许损失部分可用功能，保证核心功能可用。
- 软状态
- - 允许系统中存在中间状态，这个状态不影响系统可用性，这里指的是CAP中的不一致。
- 最终一致
- - 最终一致是指经过一段时间后，所有节点数据都将会达到一致。

BASE解决了CAP中理论没有网络延迟，在BASE中用软状态和最终一致，保证了延迟后的一致性。
BASE和 ACID 是相反的，它完全不同于ACID的强一致性模型，而是通过牺牲强一致性来获得可用性，并允许数据在一段时间内是不一致的，但最终达到一致状态。


## 2. 分布式事务的处理方案

### 2.1 两阶段提交（2PC）
2PC，Two-phase commit protocol，即两阶段提交协议，二阶段提交是一种强一致性设计，
2PC 引入一个事务协调者的角色来协调管理各参与者（也可称之为各本地资源）的提交和回滚，
二阶段分别指的是准备（投票）和提交两个阶段。

两阶段提交有两种角色：
- 事务协调者
- - 启动事务的执行
- - 将事务分成若干子事务，并将这些子事务分布到合适的站点去执行
- - 协调事务的结束，它可能导致事务被提交到所有的站点，或在所有站点终止
- 事务参与者（参与站点）
- - 在协调节点的调度下处理子事务

![图片](https://pic4.zhimg.com/80/v2-1796af8b531e3737fb710a54474a5407_720w.jpg)


具体的执行流程如下：
第一阶段：事务协调器通知参与者准备提交事务，参与者准备成功之后向协调者返回成功，若有一个参与者返回的是准备不成功，那么事务执行失败。

第二阶段：事务协调器根据各个参与者的第一阶段的返回结果，发起最终提交事务的请求，若有一个参与者提交失败，则所有参与者都执行回滚，事务执行失败。


### 2.2 三阶段提交（3PC）

### 2.3 TCC (Try - Confirm - Cancel)

### 2.4 Saga方案（补偿事务，失败补偿回滚之前数据）

### 2.5 本地消息表

### 2.6 基于可靠消息最终一致性方案

### 2.7 最大努力通知方案

